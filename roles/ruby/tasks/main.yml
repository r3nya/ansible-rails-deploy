--- 
- name: download rbenv-installer for $user
  action: get_url url=https://raw.github.com/fesplugas/rbenv-installer/master/bin/rbenv-installer dest=/tmp/rbenv-installer mode=0755

- name: run rbenv-installer
  action: raw HOME=/home/$user /tmp/rbenv-installer

- name: copy gem environment setup
  action: copy src=gemrc dest=/home/$user/.gemrc mode=0644

- name: update PATH in ~/.bashrc for rbenv
  action: lineinfile dest=$home/.bashrc line=export\ PATH="$HOME/.rbenv/bin:$PATH" regexp=PATH.*rbenv

- name: add rbenv init to ~/.bashrc
  action: lineinfile dest=$home/.bashrc line='eval "$(rbenv init -)"' regexp=eval.*rbenv

- name: install ruby $ruby_version
  action: raw HOME=$home PATH=$home/.rbenv/bin:$PATH rbenv install $ruby_version
  notify: initialize rbenv

- name: make ruby $ruby_version global
  action: shell $home/.rbenv/bin/rbenv global $ruby_version

- name: install bundler gem
  action: raw HOME=$home PATH=$home/.rbenv/bin:$PATH rbenv exec gem install bundler
  notify: rbenv rehash
